<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Asistencia</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="icono.png">
  <script type="module">
    // ------------------- Importar m칩dulos de Firebase -------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ------------------- Configuraci칩n de Firebase -------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAQWCuqqR8WPhAGUSDFb_32E1IATKA0ZCk",
      authDomain: "proyecto-control-asistencias.firebaseapp.com",
      projectId: "proyecto-control-asistencias",
      storageBucket: "proyecto-control-asistencias.appspot.com",
      messagingSenderId: "558101563015",
      appId: "1:558101563015:web:2ba0586e1c803160701a22",
      measurementId: "G-KCSE19ZVWX"
    };

    // ------------------- Inicializar Firebase -------------------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tabla = document.getElementById("tabla-datos");

    // ------------------- Funciones auxiliares -------------------

    function horasAMinutos(horasStr) {
      if (!horasStr) return 0;
      const [h, m] = horasStr.replace("m", "").split("h").map(Number);
      return h * 60 + m;
    }

    function minutosAHoras(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}h${m.toString().padStart(2, "0")}m`;
    }

    function ordenarMeses(mesesArray) {
      const mesesNum = {
        enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,
        julio:7,agosto:8,septiembre:9,octubre:10,noviembre:11,diciembre:12
      };
      return mesesArray.sort((a,b)=>{
        const [mesA,a침oA] = a.split(" ");
        const [mesB,a침oB] = b.split(" ");
        return (parseInt(a침oA)-parseInt(a침oB)) || (mesesNum[mesA.toLowerCase()]-mesesNum[mesB.toLowerCase()]);
      });
    }

    // ------------------- Funci칩n principal para cargar los datos -------------------
    async function cargarDatos(mesSeleccionado=null){
      tabla.innerHTML="<tr><td colspan='7'>Cargando datos...</td></tr>";
      try{
        const snapshot = await getDocs(collection(db,"Asistencia-del-servicio"));
        if(snapshot.empty){
          tabla.innerHTML="<tr><td colspan='7'>No hay datos disponibles</td></tr>";
          return;
        }

        const mesesSet = new Set();
        const empleados = [];

        snapshot.forEach(doc=>{
          const data = doc.data();
          const nombre = data.nombre || doc.id;
          const meses = data.meses || {};
          
          empleados.push({
            nombre,
            meses,
            area:data.area||"",
            carrera:data.carrera||""
          });

          Object.keys(meses).forEach(m=>mesesSet.add(m));
        });

        const mesesArray = ordenarMeses(Array.from(mesesSet));

        if(mesesArray.length === 0){
          tabla.innerHTML="<tr><td colspan='7'>No hay meses disponibles</td></tr>";
          return;
        }

        const mesAUsar = mesSeleccionado || mesesArray[mesesArray.length-1];

        // ------------------- Encabezado -------------------
        const thead = document.querySelector("thead tr");
        thead.innerHTML="";

        const thEmpleado = document.createElement("th");
        thEmpleado.textContent="Empleado";
        thead.appendChild(thEmpleado);

        const thMes = document.createElement("th");
        const selectMes = document.createElement("select");
        selectMes.id="mes-selector";
        mesesArray.forEach(m=>{
          const option = document.createElement("option");
          option.value=m;
          option.textContent=m;
          if(m===mesAUsar) option.selected=true;
          selectMes.appendChild(option);
        });
        selectMes.addEventListener("change",()=>{cargarDatos(selectMes.value)});
        thMes.appendChild(selectMes);
        thead.appendChild(thMes);

        const thTotal=document.createElement("th"); thTotal.textContent="Total Acumulado"; thead.appendChild(thTotal);
        const thRestante=document.createElement("th"); thRestante.textContent="Horas Restantes"; thead.appendChild(thRestante);
        const thArea=document.createElement("th"); thArea.textContent="츼rea"; thead.appendChild(thArea);
        const thCarrera=document.createElement("th"); thCarrera.textContent="Carrera"; thead.appendChild(thCarrera);

        // ------------------- Cuerpo -------------------
        tabla.innerHTML="";

        empleados.forEach(emp=>{
          if(!emp.carrera || emp.carrera.trim()==="") return;

          const totalMinutos = Object.values(emp.meses)
            .map(h=>horasAMinutos(h))
            .reduce((a,b)=>a+b,0);

          if(totalMinutos===0) return;

          let totalAcumulado=0;
          let rowHtml=`<td>${emp.nombre}</td>`;
          
          const horasMes=emp.meses[mesAUsar]||"0h00m";
          rowHtml+=`<td>${horasMes}</td>`;

          for(const m of mesesArray){
            totalAcumulado+=horasAMinutos(emp.meses[m]||"0h00m");
          }

          const metaTotalMinutos=480*60;
          let horasRestantes=metaTotalMinutos-totalAcumulado;
          if(horasRestantes<0) horasRestantes=0;

          rowHtml+=`<td>${minutosAHoras(totalAcumulado)}</td>`;

          if(horasRestantes===0){
            rowHtml+=`<td class="terminado">Terminaste el servicio 游꿀</td>`;
          }else{
            rowHtml+=`<td>${minutosAHoras(horasRestantes)}</td>`;
          }

          rowHtml+=`<td>${emp.area}</td>`;
          rowHtml+=`<td>${emp.carrera}</td>`;

          const row=document.createElement("tr");
          row.innerHTML=rowHtml;
          tabla.appendChild(row);
        });

      }catch(error){
        tabla.innerHTML=`<tr><td colspan='7'>Error: ${error.message}</td></tr>`;
        console.error(error);
      }
    }

    // ------------------- Cargar datos directamente sin autenticaci칩n -------------------
    cargarDatos();
  </script>
</head>
<body>
  <div class="header">
    <img src="udg_logo.png" alt="Logo UDG">
    <div class="text">
      <h2>Laboratorio de Inteligencia Artificial, Optimizaci칩n,<br>
      Metaheur칤stica y Tecnolog칤as Sustentables.</h2>
      <p>CUCEI, Universidad de Guadalajara.</p>
    </div>
    <img src="cucei_logo.png" alt="Logo CUCEI">
  </div>

  <h1>游늵 Reporte de asistencia de servicio social</h1>

  <table>
    <thead>
      <tr></tr>
    </thead>
    <tbody id="tabla-datos">
      <tr><td colspan="7">Cargando datos...</td></tr>
    </tbody>
  </table>
</body>
</html>






